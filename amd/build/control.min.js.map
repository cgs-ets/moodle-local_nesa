{"version":3,"file":"control.min.js","sources":["../src/control.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n// You can use this JS to modify the table after the page loads\n\n/**\n * Javascript controller for the \"Actions\" panel at the bottom of the page.\n *\n * @module     local_nesa\n * @copyright  2025 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function ($) {\n  return {\n    init: function (nesanumbers) {\n      $(document).ready(function () {\n        // Ensure the table with ID \"user-grades\" exists\n        var table = $('#user-grades');\n        nesanumbers = JSON.parse(nesanumbers);\n\n        if (table.length) {\n          // Wait for the table to load and then insert the NESA column\n          // function () {\n          // Find the heading row (tr class=\"heading\")\n          var headingRow = table.find('tr.heading');\n\n          var useremailColumn = headingRow.find('th.userfield.useremail');\n\n          // Get their column indexes\n          var emailIndex = useremailColumn.index();\n\n          // Create NESA column header (without bold)\n          var nesaHeader = $('<th>')\n            .append(\n              $('<span>').attr('data-collapse', 'content').text('NESA number'),\n            )\n            .append(\n              $('<button>')\n                .addClass('btn btn-link btn-icon icon-size-3 cellmenubtn')\n                .attr({\n                  type: 'button',\n                  'data-toggle': 'dropdown',\n                  'aria-haspopup': 'true',\n                  'aria-expanded': 'false',\n                  'data-type': 'studiescode', // Changed from 'username' to 'studiescode'\n                  'data-id': 'studiescode', // Changed from 'username' to 'studiescode'\n                })\n                .css('color', '#F8F9FA') // Set the button's color to #F8F9FA\n                .append(\n                  $('<i>')\n                    .addClass('icon fa fa-ellipsis-h fa-fw m-0')\n                    .attr('title', 'Cell actions')\n                    .attr('aria-hidden', 'true'),\n                )\n                .append($('<span>').addClass('sr-only').text('Cell actions')),\n            )\n            .addClass('userfield studiescode cell c' + emailIndex)\n            .attr({\n              'data-col': 'studiescode',\n              scope: 'col',\n            });\n\n          // Insert the NESA column header in the correct position (before useremail)\n          useremailColumn.before(nesaHeader);\n\n          // Add the NESA column to each row in the tbody\n          table.find('tbody tr').each(function () {\n            // Generate a random number between 0 and 100 for the NESA column\n            var userid = $(this).attr('data-uid');\n            var studiescode =\n              nesanumbers[userid]?.studies_code == undefined\n                ? 'N/A'\n                : nesanumbers[userid]?.studies_code; // the ? makes sure it doesnt\n            // Create the new NESA cell with a div inside\n            var nesaCell = $('<td>')\n              .addClass('userfield studiescode cell c' + emailIndex)\n              .attr('data-col', 'studiescode') // Set the data-col attribute\n              .append(\n                $('<div>')\n                  .attr('data-collapse', 'content') // Add the collapse attribute to the div\n                  .text(studiescode), // Set the random NESA number inside the div\n              );\n\n            // Find the userusername cell and insert the NESA cell before the useremail cell\n            var useremailCell = $(this).find('td.userfield.useremail').first();\n\n            // Insert the NESA cell before the useremail cell\n            useremailCell.before(nesaCell);\n          }, nesanumbers);\n\n          // Adjust the class of the useremail column in the header (shift to next column)\n          headingRow.find('th.userfield.useremail').each(function () {\n            var newClassNumber = emailIndex + 1;\n            $(this)\n              .removeClass('c' + emailIndex)\n              .addClass('c' + newClassNumber);\n          });\n\n          // Adjust the class for the useremail column cells (body rows)\n          table.find('tbody td.userfield.useremail').each(function () {\n            var newClassNumber = emailIndex + 1;\n            $(this)\n              .removeClass('c' + emailIndex)\n              .addClass('c' + newClassNumber);\n          });\n\n          // Shift classes for all columns after useremail in the heading\n          headingRow.find('th').each(function (index) {\n            if (index > emailIndex) {\n              var newClassNumber = index + 1;\n              $(this)\n                .removeClass('c' + (index + 1))\n                .addClass('c' + newClassNumber);\n            }\n          });\n\n          // Shift classes for all columns after useremail in the body rows\n          table.find('tbody td').each(function () {\n            var currentColumnIndex = $(this).index();\n            if (currentColumnIndex > emailIndex) {\n              var newClassNumber = currentColumnIndex + 1;\n              $(this)\n                .removeClass('c' + (currentColumnIndex + 1))\n                .addClass('c' + newClassNumber);\n            }\n          });\n\n          // Change the colspan to adapt to the number of userfield colums.\n          var firstTr = table.find('tr').first();\n          var topLeftCell = firstTr.find('th.cell.topleft.cell.c0');\n\n          var userfieldCount = headingRow.find('th.userfield').length;\n\n          topLeftCell.attr('colspan', userfieldCount + 1); // +1 because the firstname/lastname doesnt have theusefield class\n\n          var lastRow = table.find('tr.avg.r0.lastrow.pinned');\n\n          var lastRowCell = lastRow.find('th.header.range.cell.c0');\n\n          lastRowCell.attr('colspan', userfieldCount + 1);\n        }\n      });\n    },\n  };\n});\n"],"names":["define","$","init","nesanumbers","document","ready","table","JSON","parse","length","headingRow","find","useremailColumn","emailIndex","index","nesaHeader","append","attr","text","addClass","type","css","scope","before","each","userid","this","studiescode","undefined","studies_code","_nesanumbers$userid2","nesaCell","first","newClassNumber","removeClass","currentColumnIndex","topLeftCell","userfieldCount"],"mappings":";;;;;;;AAyBAA,4BAAO,CAAC,WAAW,SAAUC,SACpB,CACLC,KAAM,SAAUC,aACdF,EAAEG,UAAUC,OAAM,eAEZC,MAAQL,EAAE,mBACdE,YAAcI,KAAKC,MAAML,aAErBG,MAAMG,OAAQ,KAIZC,WAAaJ,MAAMK,KAAK,cAExBC,gBAAkBF,WAAWC,KAAK,0BAGlCE,WAAaD,gBAAgBE,QAG7BC,WAAad,EAAE,QAChBe,OACCf,EAAE,UAAUgB,KAAK,gBAAiB,WAAWC,KAAK,gBAEnDF,OACCf,EAAE,YACCkB,SAAS,iDACTF,KAAK,CACJG,KAAM,uBACS,2BACE,uBACA,oBACJ,wBACF,gBAEZC,IAAI,QAAS,WACbL,OACCf,EAAE,OACCkB,SAAS,mCACTF,KAAK,QAAS,gBACdA,KAAK,cAAe,SAExBD,OAAOf,EAAE,UAAUkB,SAAS,WAAWD,KAAK,kBAEhDC,SAAS,+BAAiCN,YAC1CI,KAAK,YACQ,cACZK,MAAO,QAIXV,gBAAgBW,OAAOR,YAGvBT,MAAMK,KAAK,YAAYa,MAAK,wDAEtBC,OAASxB,EAAEyB,MAAMT,KAAK,YACtBU,YACmCC,mCAArCzB,YAAYsB,kEAASI,cACjB,mCACA1B,YAAYsB,+CAAZK,qBAAqBD,aAEvBE,SAAW9B,EAAE,QACdkB,SAAS,+BAAiCN,YAC1CI,KAAK,WAAY,eACjBD,OACCf,EAAE,SACCgB,KAAK,gBAAiB,WACtBC,KAAKS,cAIQ1B,EAAEyB,MAAMf,KAAK,0BAA0BqB,QAG7CT,OAAOQ,YACpB5B,aAGHO,WAAWC,KAAK,0BAA0Ba,MAAK,eACzCS,eAAiBpB,WAAa,EAClCZ,EAAEyB,MACCQ,YAAY,IAAMrB,YAClBM,SAAS,IAAMc,mBAIpB3B,MAAMK,KAAK,gCAAgCa,MAAK,eAC1CS,eAAiBpB,WAAa,EAClCZ,EAAEyB,MACCQ,YAAY,IAAMrB,YAClBM,SAAS,IAAMc,mBAIpBvB,WAAWC,KAAK,MAAMa,MAAK,SAAUV,UAC/BA,MAAQD,WAAY,KAClBoB,eAAiBnB,MAAQ,EAC7Bb,EAAEyB,MACCQ,YAAY,KAAOpB,MAAQ,IAC3BK,SAAS,IAAMc,oBAKtB3B,MAAMK,KAAK,YAAYa,MAAK,eACtBW,mBAAqBlC,EAAEyB,MAAMZ,WAC7BqB,mBAAqBtB,WAAY,KAC/BoB,eAAiBE,mBAAqB,EAC1ClC,EAAEyB,MACCQ,YAAY,KAAOC,mBAAqB,IACxChB,SAAS,IAAMc,wBAMlBG,YADU9B,MAAMK,KAAK,MAAMqB,QACLrB,KAAK,2BAE3B0B,eAAiB3B,WAAWC,KAAK,gBAAgBF,OAErD2B,YAAYnB,KAAK,UAAWoB,eAAiB,GAE/B/B,MAAMK,KAAK,4BAECA,KAAK,2BAEnBM,KAAK,UAAWoB,eAAiB"}